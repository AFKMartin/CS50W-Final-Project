{% extends "explorer/layout.html" %}

{% load static %}

{% block title %}Collatz Game{% endblock %}

{% block content %}

<div class="text-center">
  <h1 class="mb-4">Collatz Conjecture Game</h1>

  <!-- Description -->
  <p id="conjecture" class="lead fade">
    The Collatz conjecture states that if you start with any positive integer and repeatedly apply the following rules:<br><br>
    if the number is even, divide it by 2;<br><br>
    if the number is odd, multiply it by 3 and add 1;<br><br>
    then you will eventually reach 1
  </p>

  <p id="rules" class="mt-3 fade">
    In this game you will have to test a number between 1 and 1,000,000
    to check both, how many steps it takes you to reach 1 
    and what was the max value your number reached
  </p>

  {% if not result and not error %}
  <button id="startBtn" class="btn btn-primary mt-4">Start the Game</button>
  {% endif %}

  <!-- Game area -->
  <div id="gameArea" class="mt-5 {% if not result %}d-none{% endif %}">
    <!-- Input form -->
    <form method="post" action="{% url 'collatz' %}" class="mb-4">
      {% csrf_token %}
      <input type="number" name="number" placeholder="Enter a number between 1 and 1,000,000"
            class="form-control mx-auto" style="max-width: 330px;" required>
      <button type="submit" class="btn btn-primary mt-2">Test the number!</button>
    </form>

    <!-- Error message -->
    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <!-- Results -->
    {% if result %}
      <div class="mb-3">
        <p>Total steps: <strong>{{ result.steps }}</strong></p>
        <p>Max value: <strong>{{ result.max_value }}</strong></p>
        {% if result.truncated %}
          <p class="text-warning">Sequence truncated at maximum allowed steps (1,000)</p>
        {% endif %}
      </div>

      <!-- Visualization tabs -->
      <ul class="nav nav-tabs justify-content-center mb-3" id="vizTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="mountain-tab" data-bs-toggle="tab"
                  data-bs-target="#mountain" type="button">Mountain View</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="spiral-tab" data-bs-toggle="tab"
                  data-bs-target="#spiral" type="button">Spiral View</button>
        </li>
      </ul>

      <div class="tab-content" id="vizTabContent">
        <div class="tab-pane fade show active" id="mountain" role="tabpanel">
          <div style="overflow-x: auto;">
            <canvas id="mountainChart" width="1000" height="400"
                    style="max-width:100%; border: 1px solid #dee2e6; border-radius: 4px; background: white;">
            </canvas>
          </div>
        </div>
        <div class="tab-pane fade" id="spiral" role="tabpanel">
          <div style="overflow-x: auto;">
            <canvas id="spiralChart" width="600" height="600"
                    style="max-width: 100%; border: 1px solid #dee2e6; border-radius: 4px; background: white;">
            </canvas>
          </div>
        </div>
      </div>

      <!-- Pass sequence safely -->
      {{ result.sequence|json_script:"collatz-data" }}
    {% endif %}
  </div>

<!-- Load collatz.js -->
<script src="{% static 'explorer/collatz.js' %}"></script>
{% endblock %}    