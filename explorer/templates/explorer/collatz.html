{% extends "explorer/layout.html" %}

{% load static %}

{% block title %}Collatz Game{% endblock %}

{% block content %}

<div class="text-center">
  <h1 class="mb-4">Collatz Conjeture Game</h1>
  
  <!-- Input form -->
   <form method="post" action="{% url 'collatz' %}" class="mb-4">
      {% csrf_token %}
        <input type="number" name="number" placeholder="Enter a number between 1 and 1.000.000" class="form-control mx-auto" style="max-width: 330px;">
          <button type="submit" class="btn btn-primary mt-2">Test the number!</button>
   </form>

  <!-- Error message -->
   {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
   {% endif %}
  
  <!-- Results -->
   {% if result %}
    <div class="mb-3">
      <p>Total steps: <strong>{{ result.steps }}</strong></p>
      <p>Max value: <strong>{{ result.max_value }}</strong></p>
      {% if result.truncated %}
        <p class="text-warning">Sequence truncated at maximum allowed steps (1.000)</p>
      {% endif %}
    </div>
  
  <!-- Visualization container -->
    <div style="overflow-x: auto;">
      <canvas id="collatzCanvas" width="600" height="600" style="max-width: 100%;"></canvas>
    </div>
  
  <!-- Pass sequence safely -->
    {{ result.sequence|json_script:"collatz-data" }}

   <script>
    window.addEventListener("DOMContentLoaded", () => {
      const canvas = document.getElementById("collatzCanvas");
      const json_script = document.getElementById("collatz-data");

      if (!canvas || !json_script) return;

      const sequence = JSON.parse(json_script.textContent);
      const ctx = canvas.getContext("2d");

      // screen adjust
      const dpr = window.devicePixelRatio || 1;
      canvas.width *= dpr;
      canvas.height *= dpr;
      ctx.scale(dpr, dpr);
      const width = canvas.width / dpr;
      const height = canvas.height / dpr;

      // center
      let x = width / 2;
      let y = height / 2;
      let angle = 0; // this is rad
      
      const angleStep = Math.PI / 6; // turn for each step
      const scale = 6;

      ctx.clearRect(0, 0, width, height);
      ctx.lineWidth = 1.2;
      ctx.strokeStyle = "#1f77b4";
      ctx.beginPath();
      ctx.moveTo(x, y);

      sequence.forEach((value) => {
        const stepLength = Math.log(value + 1) * scale;

        // Even -> Right, Odd -> Left
        if (value % 2 === 0) {
          angle += angleStep;
        } else {
          angle -= angleStep;
        }

        const newX = x + Math.cos(angle) * stepLength;
        const newY = y + Math.sin(angle) * stepLength;

        ctx.lineTo(newX, newY);

        x = newX;
        y = newY;
      });

      ctx.stroke();

      // endpoint
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.arc(x, y, 3, 0, 2 * Math.PI);
      ctx.fill();
    });
   </script>
  {% endif %}
</div>
{% endblock %}
